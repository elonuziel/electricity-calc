name: Build & Release APK

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm install

      - name: Bump version in package.json
        id: bump_version
        run: |
          npm version ${{ github.event.inputs.bump_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Generate Changelog
        id: changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_TAG="v${{ steps.bump_version.outputs.version }}"

          # Get the last release tag
          LAST_TAG=$(git tag --sort=-version:refname | head -n 1)

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s" "${LAST_TAG}..HEAD")
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="- Maintenance and improvements"
          fi

          # Write a clean summary grouping lines into categories
          FEATURES=""
          FIXES=""
          OTHER=""

          while IFS= read -r line; do
            lower=$(echo "$line" | tr '[:upper:]' '[:lower:]')
            if echo "$lower" | grep -qE "^- (feat|add|new|improv|updat|enhanc)"; then
              FEATURES="$FEATURES\n$line"
            elif echo "$lower" | grep -qE "^- (fix|bug|patch|resolv|correct|revert)"; then
              FIXES="$FIXES\n$line"
            else
              OTHER="$OTHER\n$line"
            fi
          done <<< "$COMMITS"

          BODY=""
          if [ -n "$FEATURES" ]; then
            BODY="$BODY\n### âš¡ Improvements\n$FEATURES\n"
          fi
          if [ -n "$FIXES" ]; then
            BODY="$BODY\n### ðŸ› Fixes\n$FIXES\n"
          fi
          if [ -n "$OTHER" ]; then
            BODY="$BODY\n### ðŸ”§ Other Changes\n$OTHER\n"
          fi

          # Fallback
          if [ -z "$BODY" ]; then
            BODY="- General updates and improvements"
          fi

          # Save to file for later step (avoids multiline env issues)
          printf "%b" "$BODY" > changelog.txt
          echo "Generated changelog:"
          cat changelog.txt

      - name: Commit version bump and push tag
        run: |
          git add package.json
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.version }}"
          git tag ${{ steps.bump_version.outputs.tag }}
          git push origin HEAD:main --follow-tags

      - name: Add Android platform
        run: |
          if [ ! -d "android" ]; then
            npx cap add android
          fi

      - name: Generate Custom App Icons
        run: npx @capacitor/assets generate --assetPath assets --android

      - name: Sync web assets into Android project
        run: npx cap sync android

      - name: Inject version into Android build
        run: |
          # Set versionName and versionCode in build.gradle
          sed -i "s/versionName \".*\"/versionName \"${{ steps.bump_version.outputs.version }}\"/" android/app/build.gradle
          sed -i "s/versionCode [0-9]*/versionCode ${{ github.run_number }}/" android/app/build.gradle

      - name: Make Gradlew executable
        run: chmod +x android/gradlew

      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug

      - name: Rename APK with version
        run: |
          cp android/app/build/outputs/apk/debug/app-debug.apk \
             electricity-calc-${{ steps.bump_version.outputs.version }}.apk

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "electricity-calc-${{ steps.bump_version.outputs.version }}.apk"
          tag: ${{ steps.bump_version.outputs.tag }}
          name: "Electricity Calc ${{ steps.bump_version.outputs.tag }}"
          bodyFile: changelog.txt
          token: ${{ secrets.GITHUB_TOKEN }}
